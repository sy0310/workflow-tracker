<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>前端功能测试</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>测试结果</h5>
            </div>
            <div class="card-body">
                <div id="test-results"></div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let html = '';
            
            // 测试 1: 检查认证状态
            html += '<h6>1. 检查认证状态</h6>';
            const auth = AuthManager.checkAuth();
            if (auth) {
                html += `<p class="text-success">✅ 已登录: ${auth.user.username}</p>`;
            } else {
                html += '<p class="text-danger">❌ 未登录</p>';
                resultsDiv.innerHTML = html;
                return;
            }
            
            // 测试 2: 测试 API 调用
            html += '<h6>2. 测试 API 调用</h6>';
            
            const apis = [
                { name: '用户信息', url: '/api/auth/me' },
                { name: '人员列表', url: '/api/staff' },
                { name: '产业分析项目', url: '/api/departments/产业分析/projects' },
                { name: '创意实践项目', url: '/api/departments/创意实践/projects' },
                { name: '活动策划项目', url: '/api/departments/活动策划/projects' },
                { name: '资源拓展项目', url: '/api/departments/资源拓展/projects' }
            ];
            
            for (const api of apis) {
                try {
                    const response = await fetch(api.url, {
                        headers: AuthManager.getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const count = Array.isArray(data) ? data.length : 'N/A';
                        html += `<p class="text-success">✅ ${api.name}: ${response.status} (${count} 项)</p>`;
                    } else {
                        const error = await response.json();
                        html += `<p class="text-danger">❌ ${api.name}: ${response.status} - ${error.error || '未知错误'}</p>`;
                    }
                } catch (error) {
                    html += `<p class="text-danger">❌ ${api.name}: ${error.message}</p>`;
                }
            }
            
            // 测试 3: 检查 DOM 元素
            html += '<h6>3. 检查主页 DOM 元素</h6>';
            const elements = [
                'departments-section',
                'department-projects',
                'project-department'
            ];
            
            // 打开主页检查
            const mainPageResponse = await fetch('/');
            const mainPageHtml = await mainPageResponse.text();
            
            for (const elementId of elements) {
                if (mainPageHtml.includes(`id="${elementId}"`)) {
                    html += `<p class="text-success">✅ 找到元素: ${elementId}</p>`;
                } else {
                    html += `<p class="text-danger">❌ 未找到元素: ${elementId}</p>`;
                }
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // 页面加载后运行测试
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
